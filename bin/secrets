#!/usr/bin/env bash
set -eo pipefail

if ! op whoami >/dev/null 2>&1; then
    echo "Please login to 1Password!"
    exit 1
fi

export GH_TOKEN=$(op read op://Gexec/Github/token)

echo "---> bot token for all repos"
gh secret set BOT_ACCESS_TOKEN --body "$(op read op://Gexec/Github/token)" --org gexec --visibility all --app actions

for APP in dependabot actions; do
    echo "---> token app for public repos (${APP})"
    gh secret set TOKEN_EXCHANGE_APP --body "1130928" --org gexec --visibility all --app ${APP}

    echo "---> token install for public repos (${APP})"
    gh secret set TOKEN_EXCHANGE_INSTALL --body "60411430" --org gexec --visibility all --app ${APP}

    echo "---> token key for public repos (${APP})"
    gh secret set TOKEN_EXCHANGE_KEY --body "$(op read op://Gexec/Github/exchangekey | base64 --decode)" --org gexec --visibility all --app ${APP}

    for REPO in .github gexec-infra; do
        echo "---> access key for ${REPO}"
        gh secret set AWS_ACCESS_KEY_ID --body "$(op read op://Gexec/ObjectsTerraform/username)" --repo "gexec/${REPO}" --app ${APP}

        echo "---> secret key for ${REPO}"
        gh secret set AWS_SECRET_ACCESS_KEY --body "$(op read op://Gexec/ObjectsTerraform/password)" --repo "gexec/${REPO}" --app ${APP}
    done
done

for REPO in gexec-docs; do
    echo "---> netlify site for ${REPO}"
    gh secret set NETLIFY_SITE_ID --body "$(op read op://Gexec/Netlify/site_id)" --repo "gexec/${REPO}"

    echo "---> netlify auth for ${REPO}"
    gh secret set NETLIFY_AUTH_TOKEN --body "$(op read op://Gexec/Netlify/auth_token)" --repo "gexec/${REPO}"
done
